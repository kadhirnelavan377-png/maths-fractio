<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maths AR:Explorer</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<!-- âœ… KIDS MODE BUTTON -->
<button id="kidsBtn">ðŸ§¸ Kids Mode ðŸ§¸</button>

<div class="app">
  <div class="stage">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay" class="overlay"></canvas>
  </div>

  <div class="panel">
    <h2>AR Fractions</h2>

    <p><b>Object:</b> <span id="obj">â€”</span></p>
    <p><b>Confidence:</b> <span id="conf">â€”</span></p>
    <p><b>Fraction:</b> <span id="fraction">â€”</span></p>
    <p><b>Simplified:</b> <span id="simple">â€”</span></p>
    <p><b>Percentage:</b> <span id="percent">â€”</span></p>

    <label>Grid Cells
      <input id="gridCount" type="number" value="12" min="2" max="48">
    </label>

    <div id="grid" class="grid"></div>

    <!-- ðŸ”Š SPEAK -->
    <button class="btn" id="speakBtn">ðŸ”Š Speak Explanation</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

const obj = document.getElementById("obj");
const conf = document.getElementById("conf");
const fractionEl = document.getElementById("fraction");
const simpleEl = document.getElementById("simple");
const percentEl = document.getElementById("percent");
const grid = document.getElementById("grid");
const gridCountInput = document.getElementById("gridCount");

let model;
let smooth = 0;

/* ================= EUCLID GCD ================= */
function gcd(a, b){
  while(b !== 0){
    let t = b;
    b = a % b;
    a = t;
  }
  return a;
}

/* ================= CAMERA ================= */
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment" }
    });
    video.srcObject = stream;
    await new Promise(r => video.onloadedmetadata = r);
    video.play();

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.setTransform(-1,0,0,1,canvas.width,0);

    startDetection();
  }catch{
    alert("Camera access denied. Allow camera & reload.");
  }
}

/* ================= GRID ================= */
function drawGrid(total, filled){
  grid.innerHTML="";
  for(let i=0;i<total;i++){
    const c=document.createElement("div");
    c.className="cell"+(i<filled?" filled":"");
    grid.appendChild(c);
  }
}

/* ================= MODEL ================= */
async function startDetection(){
  model = await cocoSsd.load();
  detect();
}

async function detect(){
  if(video.readyState!==4){
    requestAnimationFrame(detect);
    return;
  }

  const preds = await model.detect(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(preds.length){
    const p = preds[0];
    obj.innerText = p.class;
    conf.innerText = (p.score*100).toFixed(1)+"%";

    const area = p.bbox[2]*p.bbox[3];
    const frame = canvas.width*canvas.height;
    smooth = smooth*0.85 + (area/frame)*0.15;

    const total = parseInt(gridCountInput.value)||12;
    const filled = Math.max(0,Math.min(total,Math.floor(smooth*total)));

    /* EXACT FRACTION */
    fractionEl.innerText = filled+"/"+total;

    /* SIMPLIFIED USING GCD */
    const g = gcd(filled, total);
    simpleEl.innerText = (filled/g)+"/"+(total/g);

    /* EXACT PERCENT */
    percentEl.innerText = ((filled/total)*100).toFixed(1)+"%";

    drawGrid(total,filled);
  }

  requestAnimationFrame(detect);
}

startCamera();

/* ================= SPEAK ================= */
document.getElementById("speakBtn").addEventListener("click",()=>{
  const raw = fractionEl.innerText.split("/");
  const simp = simpleEl.innerText;

  const text =
    `The detected object is ${obj.innerText}.
     The grid shows the fraction ${raw[0]} out of ${raw[1]}.
     Using Euclid's algorithm, the simplified fraction is ${simp}.
     This is equal to ${percentEl.innerText}.`;

  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
});
</script>

<!-- ================= KIDS MODE ================= -->
<script>
const kidsBtn=document.getElementById("kidsBtn");
let kidsMode=false;

kidsBtn.addEventListener("click",()=>{
  kidsMode=!kidsMode;
  document.body.classList.toggle("kids",kidsMode);
  kidsBtn.textContent=kidsMode?"ðŸ§¸ Kids Mode ON":"ðŸ§¸ Kids Mode ðŸ§¸";
});
</script>

</body>
</html>
